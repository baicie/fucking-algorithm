### 浏览器事件循环

浏览器需要事件循环来协调事件、用户操作、脚本执行、渲染、网络请求等。通过事件循环，浏览器可以利用任务队列来管理任务，让异步事件非阻塞地执行。每个客户端对应的事件循环是相对独立的。

#### 什么是浏览器事件循环

Event Loop 可以理解为一个消息分发器，通过接收和分发不同类型的消息，让执行程序的事件调度更加合理

**浏览器事件循环是以浏览器为宿主环境实现的事件调度**

1. 执行同步代码。
2. 执行一个任务（执行栈中没有就从任务队列中获取）。
3. 执行过程中如果遇到微任务，就将它添加到微任务的任务队列中。
4. 任务执行完毕后，立即执行当前微任务队列中的所有微任务（依次执行）。
5. 当前任务执行完毕，开始检查渲染，然后渲染线程接管进行渲染。
6. 渲染完毕后，JavaScript 线程继续接管，开始下一个循环。

#### 浏览器为什么需要事件循环

| 问题             | 事件循环的作用          |
| -------------- | ---------------- |
| JS 单线程无法并行处理异步 | 通过事件队列异步调度       |
| 页面需要持续响应用户     | 把耗时任务放入队列，不阻塞主线程 |
| 页面需要高性能渲染      | 每轮事件循环中插入渲染步骤    |

#### 任务与微任务

 宏任务

- setTimeout, setInterval
- DOM 事件回调
- MessageChannel
- requestAnimationFrame

 微任务

- Promise.then
- MutationObserver
- queueMicrotask

#### Node.js 中的事件循环

| 特性      | Node.js                                                 | 浏览器                                                    |
| ------- | ------------------------------------------------------- | ------------------------------------------------------ |
| 宿主环境    | 服务端，基于 libuv                                            | 客户端，基于浏览器引擎（如 Chromium）                                |
| 阶段模型    | 多阶段（timers、poll、check 等）                                | 两队列模型（宏任务、微任务）                                         |
| 微任务处理时机 | 每个阶段后处理所有微任务                                            | 每个宏任务后处理所有微任务                                          |
| 宏任务来源   | `setTimeout`, `setImmediate`, `I/O`, `poll`, `check` 阶段 | `setTimeout`, `setInterval`, `requestAnimationFrame` 等 |
| 渲染      | 无需渲染                                                    | 需协调 UI 渲染与任务调度                                         |
